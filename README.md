# ip go region

一个提供快速ip到区域转换的离线库
本项目基于 [ip2region](https://github.com/lionsoul2014/ip2region)，分离出 `golang` 版本生成及查询功能代码并作结构调整，旨在增加较少io的情况下缩减xdb大小。

## 进度
|主要指标|本项目|原项目|
|-|-|-|
|xdb文件大小|6.5M|11.1M|
|单次查询io|n + 1(2)|n|
> 大部分情况io固定为 n+1，除非有对原始文件`ip.merge.txt` 行内容进行扩充，导致地域尾部信息超长，此时io将变为 n+2

## 使用
```golang
```


## 结构调整
### 拆分地域信息
由于目前地域信息都是使用 [ip.merge.txt](https://github.com/lionsoul2014/ip2region/blob/master/data/ip.merge.txt) 进行生成，所以本次拆分也基于此文件行格式，即：
`startIP|endIP|国家|区域|省(州)|城市|isp`

其中地域信息 `国家|区域|省(州)|城市|isp` 拆分为头部，尾部两段分开存储，以减小重复内容


#### 1. 地域头部信息
包含前三段：`国家|区域|省(州)`，头部信息相对固定，目前排重后总数为40397B，故采用块起始地址+偏移量进行定位，块起始地址(4B)存储于header[16:20]，偏移量(2B)则记入到地域尾部信息，此操作将固定增加一次io。

头部信息存储结构：
|信息长度|信息|
|-|-|
|1 Byte|n Bytes(n < 64)|

> 若对原始文件中此三段内容进行扩充(新增非重复信息)，请注意剩余可分配Byte数量限制65535(2B) - 40397 = 25138

> n < 64: 为了读取效率，此信息行长度，已限制不得超过64B，排除行首标志位(1B)，即单行信息应<=63B(目前已有的最长仅47B)，扩充原始文件时需注意。


#### 2. 地域尾部信息
即为前三段后所有内容，目前包括 `城市|isp`，可扩展，
64B内则同原查询一样仅一次io，超过后(<=255B)将增加一次io。

尾部信息存储结构：
|头部偏移量|信息长度|信息|
|-|-|-|
|2 Bytes|1 Byte|n Bytes(n <= 255)|


> 前 2B 用于定位头部信息

> 之后 1B 用于记录尾部信息byte长度

> 尾部信息byte长度可扩展，可以达到1B能代表的最大长度，即 n <= 255，但鉴于目前的尾部信息长度，仅尝试读取64B，若扩展后超过此长度，将增加一次io用来获取行缺少的内容，可于搜索时不开启全文查找，此时将不进行增量查询，即不会增加io。


### 缩减二分索引长度，由原来的 14 Bytes 改为 8 Bytes，新结构为
|startIpTail|endIpTail|regionTailPtr|
|-|-|-|-|
|2B|2B|4B|
> 由于所有查询均使用了vector块进行第一次寻址，所以二分区块内去除了无用的ip前两段数值，仅保留开始与结束ip的后两段，即startIpTail,endIpTail

> 由于地域信息1:n二分索引，所以这里二分索引内的长度段移除，改为记录到地域尾部信息内，更加节省空间

## 指标参考

## License
本项目遵循 MIT License，原始项目遵循 Apache 2.0 License，详细内容请查看 [LICENSE](./LICENSE)